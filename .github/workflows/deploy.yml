name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild all images"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE_TAG: ${{ github.sha }}
  
jobs:
  # ===========================================
  # CHANGE DETECTION - Detect what needs to be rebuilt
  # ===========================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend || 'false' }}
      telegram-changed: ${{ steps.changes.outputs.telegram || 'false' }}
      ml-api-changed: ${{ steps.changes.outputs.mlapi || 'false' }}
      nginx-changed: ${{ steps.changes.outputs.nginx || 'false' }}
      any-changed: ${{ steps.any-changed.outputs.any-changed }}
      should-build: ${{ steps.should-build.outputs.result }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for change detection

      - name: Determine if build is needed
        id: should-build
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ Force rebuild requested via workflow dispatch"
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ Pull request to main branch - building images"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ Push to develop branch - checking for changes"
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "â© No build needed for this event"
          fi

      - name: Get base commit for comparison
        id: get-base
        if: steps.should-build.outputs.result == 'true'
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # For push events: use previous commit
            BASE_SHA=$(git rev-parse HEAD~1)
            echo "base-sha=$BASE_SHA" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Push event - comparing with previous commit"
            echo "Current commit: ${{ github.sha }}"
            echo "Previous commit: $BASE_SHA"
          else
            # For pull requests: use target branch base
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            echo "base-sha=$BASE_SHA" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Pull request - comparing with target branch"
            echo "Current commit: ${{ github.sha }}"
            echo "Target base: $BASE_SHA"
          fi

      - name: Detect file changes
        uses: dorny/paths-filter@v2
        id: changes
        if: steps.should-build.outputs.result == 'true'
        with:
          base: ${{ steps.get-base.outputs.base-sha }}
          filters: |
            backend:
              - 'backend/**'
            telegram:
              - 'telegram-bot/**'  
            mlapi:
              - 'analysis/distractor_api/**'
              - 'analysis/bert/**'
            nginx:
              - 'frontend-website/**'
              - 'backend/nginx-container/**'

      - name: Check if any component changed
        id: any-changed
        if: steps.should-build.outputs.result == 'true'
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "any-changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ Force rebuild - all components will be built"
          elif [[ "${{ steps.changes.outputs.backend }}" == "true" || \
                "${{ steps.changes.outputs.telegram }}" == "true" || \
                "${{ steps.changes.outputs.mlapi }}" == "true" || \
                "${{ steps.changes.outputs.nginx }}" == "true" ]]; then
            echo "any-changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ” Changes detected in: backend=${{ steps.changes.outputs.backend }}, telegram=${{ steps.changes.outputs.telegram }}, ml-api=${{ steps.changes.outputs.mlapi }}, nginx=${{ steps.changes.outputs.nginx }}"
          else
            echo "any-changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ” No component changes detected"
          fi

  # ===========================================
  # BUILD STAGE - Build only changed Docker images or all on PR to main
  # ===========================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-build == 'true' && (needs.detect-changes.outputs.any-changed == 'true' || github.event_name == 'workflow_dispatch')
    outputs:
      image-tag: ${{ env.IMAGE_TAG }}
      build-completed: ${{ steps.build-summary.outputs.completed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine what to build
        id: build-strategy
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
            echo "ğŸ”¨ PR to main: Building all components"
            echo "build-all=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "ğŸ”¨ Force rebuild: Building all components"
            echo "build-all=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”¨ Selective build based on changes"
            echo "build-all=false" >> $GITHUB_OUTPUT
          fi

      # Backend Build
      - name: Extract metadata for backend
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.backend-changed == 'true'
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/fluentlyorg/fluently-backend
          tags: |
            type=ref,event=branch,suffix=-{{sha}}
            type=ref,event=pr,suffix=-{{sha}}
            type=raw,value=latest-develop,enable={{is_default_branch}}
            type=raw,value=latest-main,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push backend image
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.backend-changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SWAGGER_HOST=localhost:8070

      # Telegram Bot Build  
      - name: Extract metadata for telegram-bot
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.telegram-changed == 'true'
        id: meta-telegram
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/fluentlyorg/fluently-telegram-bot
          tags: |
            type=ref,event=branch,suffix=-{{sha}}
            type=ref,event=pr,suffix=-{{sha}}
            type=raw,value=latest-develop,enable={{is_default_branch}}
            type=raw,value=latest-main,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push telegram-bot image
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.telegram-changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./telegram-bot
          file: ./telegram-bot/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-telegram.outputs.tags }}
          labels: ${{ steps.meta-telegram.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ML API Build (Most expensive - 15 minutes)
      - name: Extract metadata for ml-api
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.ml-api-changed == 'true'
        id: meta-ml-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/fluentlyorg/fluently-ml-api
          tags: |
            type=ref,event=branch,suffix=-{{sha}}
            type=ref,event=pr,suffix=-{{sha}}
            type=raw,value=latest-develop,enable={{is_default_branch}}
            type=raw,value=latest-main,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push ML API image
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.ml-api-changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./analysis
          file: ./analysis/distractor_api/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-ml-api.outputs.tags }}
          labels: ${{ steps.meta-ml-api.outputs.labels }}
          cache-from: |
            type=gha
            type=registry,ref=docker.io/fluentlyorg/fluently-ml-api:buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=docker.io/fluentlyorg/fluently-ml-api:buildcache,mode=max
          platforms: linux/amd64  # Single platform for faster builds
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Nginx Build
      - name: Extract metadata for nginx
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.nginx-changed == 'true'
        id: meta-nginx
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/fluentlyorg/fluently-nginx
          tags: |
            type=ref,event=branch,suffix=-{{sha}}
            type=ref,event=pr,suffix=-{{sha}}
            type=raw,value=latest-develop,enable={{is_default_branch}}
            type=raw,value=latest-main,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push nginx image
        if: steps.build-strategy.outputs.build-all == 'true' || needs.detect-changes.outputs.nginx-changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/nginx-container/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-nginx.outputs.tags }}
          labels: ${{ steps.meta-nginx.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build summary
        id: build-summary
        run: |
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "âœ… Build stage completed successfully"
          if [ "${{ steps.build-strategy.outputs.build-all }}" = "true" ]; then
            echo "ğŸ”¨ Built all components (PR to main or force rebuild)"
          else
            echo "ğŸ”¨ Built only changed components"
          fi

  # ===========================================
  # TEST STAGE - Run tests and quality checks
  # ===========================================
  test:
    name: Test & Quality Checks
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/develop'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_fluently_db
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: |
          cd backend
          go mod download

      - name: Run backend tests
        env:
          DB_HOST: localhost
          DB_PORT: 5433
          DB_USER: test_user
          DB_PASSWORD: test_password
          DB_NAME: test_fluently_db
          REDIS_ADDR: localhost:6379
        run: |
          cd backend
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage reports
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: backend/coverage.html

      - name: Validate Docker Compose
        run: |
          echo "ğŸ³ Validating Docker Compose configuration..."
          docker compose config --quiet
          echo "âœ… Docker Compose configuration is valid"

  # ===========================================
  # PRODUCTION DEPLOY - Deploy to production (main branch only)
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build, test]
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            
            echo "ğŸš€ Starting production deployment..."
            cd /home/deploy/Fluently-fork
            
            # Create backup
            echo "ğŸ“¦ Creating backup..."
            BACKUP_DIR="/home/deploy/backups"
            mkdir -p "$BACKUP_DIR"
            BACKUP_FILE="$BACKUP_DIR/fluently-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf "$BACKUP_FILE" --exclude=node_modules --exclude=.git . || echo "âš ï¸ Backup failed"
            
            # Keep only last 5 backups
            ls -t "$BACKUP_DIR"/fluently-backup-*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
            
            # Update code
            echo "ğŸ“¥ Updating code..."
            git config --global --add safe.directory $(pwd)
            git fetch origin
            git checkout main
            git pull origin main
            
            # Update environment
            echo "âš™ï¸ Setting up environment..."
            if [ ! -f ".env" ]; then
              cp .env.example .env
              echo "âš ï¸ Created .env from example - please configure production settings"
            fi
            
            # Pull latest images and deploy using the main docker-compose.yml
            echo "ğŸ³ Pulling latest images..."
            docker compose pull
            
            echo "ğŸ”„ Restarting services..."
            docker compose down --remove-orphans || true
            docker compose up -d
            
            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 30
            
            # Health check
            echo "ğŸ¥ Checking service health..."
            
            # Check backend
            for i in {1..10}; do
              if curl -f -s "http://localhost:8070/health" >/dev/null 2>&1; then
                echo "âœ… Backend is healthy"
                break
              elif [ $i -eq 10 ]; then
                echo "âŒ Backend health check failed"
                docker compose logs backend
                exit 1
              else
                echo "â³ Waiting for backend... (attempt $i/10)"
                sleep 15
              fi
            done
            
            # Check nginx
            for i in {1..5}; do
              if curl -f -s "http://localhost" >/dev/null 2>&1; then
                echo "âœ… Nginx is healthy"
                break
              elif [ $i -eq 5 ]; then
                echo "âŒ Nginx health check failed"
                docker compose logs nginx
                exit 1
              else
                echo "â³ Waiting for nginx... (attempt $i/5)"
                sleep 10
              fi
            done
            
            echo "ğŸ‰ Production deployment completed successfully!"
            echo "ğŸŒ Application available at: https://fluently-app.ru"
            
            # Show running containers
            docker compose ps

  # ===========================================
  # STAGING DEPLOY - Deploy to staging (develop branch)
  # ===========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: [detect-changes]
    # Note: staging deploys even if no changes (uses existing images)
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_DEPLOY_HOST }}
          username: ${{ secrets.STAGING_DEPLOY_USERNAME }}
          key: ${{ secrets.STAGING_DEPLOY_SSH_KEY }}
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            
            echo "ğŸš€ Starting staging deployment..."
            cd /home/deploy-staging/Fluently-fork
            
            # Create backup
            echo "ğŸ“¦ Creating staging backup..."
            BACKUP_DIR="/home/deploy-staging/backups"
            mkdir -p "$BACKUP_DIR"
            BACKUP_FILE="$BACKUP_DIR/fluently-staging-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf "$BACKUP_FILE" --exclude=node_modules --exclude=.git . || echo "âš ï¸ Backup failed"
            
            # Keep only last 3 staging backups
            ls -t "$BACKUP_DIR"/fluently-staging-backup-*.tar.gz 2>/dev/null | tail -n +4 | xargs rm -f 2>/dev/null || true
            
            # Update code
            echo "ğŸ“¥ Updating code..."
            git config --global --add safe.directory $(pwd)
            git fetch origin
            git checkout develop
            git pull origin develop
            
            # Setup staging environment
            echo "âš™ï¸ Setting up staging environment..."
            if [ ! -f ".env" ]; then
              cp .env.example .env
            fi
            
            # Configure staging-specific environment variables
            sed -i "s/ZEROTIER_IP=.*/ZEROTIER_IP=${{ secrets.STAGING_ZEROTIER_IP }}/" .env
            sed -i "s|PUBLIC_URL=.*|PUBLIC_URL=https://fluently-app.online|g" .env
            sed -i "s/DOMAIN=.*/DOMAIN=fluently-app.online/" .env
            sed -i "s/CERT_NAME=.*/CERT_NAME=fluently-app-online/" .env
            
            # Set staging telegram bot configuration
            if [ ! -z "${{ secrets.STAGING_TELEGRAM_BOT_TOKEN }}" ]; then
              sed -i "s/BOT_TOKEN=.*/BOT_TOKEN=${{ secrets.STAGING_TELEGRAM_BOT_TOKEN }}/" .env
            fi
            if [ ! -z "${{ secrets.STAGING_WEBHOOK_SECRET }}" ]; then
              sed -i "s/WEBHOOK_SECRET=.*/WEBHOOK_SECRET=${{ secrets.STAGING_WEBHOOK_SECRET }}/" .env
            fi
            
            # Set staging database configuration
            sed -i "s/DB_NAME=.*/DB_NAME=fluently_staging_db/" .env
            sed -i "s/DB_USER=.*/DB_USER=staging_user/" .env
            if [ ! -z "${{ secrets.STAGING_DB_PASSWORD }}" ]; then
              sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}/" .env
            fi
            
            # Pull latest images and deploy using the same docker-compose.yml
            echo "ğŸ³ Pulling latest staging images..."
            docker compose pull
            
            echo "ğŸ”„ Restarting staging services..."
            docker compose down --remove-orphans || true
            docker compose up -d
            
            # Wait for services to be healthy
            echo "â³ Waiting for staging services to be healthy..."
            sleep 30
            
            # Health check
            echo "ğŸ¥ Checking staging service health..."
            
            # Check backend
            for i in {1..10}; do
              if curl -f -s "http://localhost:8070/health" >/dev/null 2>&1; then
                echo "âœ… Staging backend is healthy"
                break
              elif [ $i -eq 10 ]; then
                echo "âŒ Staging backend health check failed"
                docker compose logs backend
                exit 1
              else
                echo "â³ Waiting for staging backend... (attempt $i/10)"
                sleep 15
              fi
            done
            
            # Check nginx
            for i in {1..5}; do
              if curl -f -s "http://localhost" >/dev/null 2>&1; then
                echo "âœ… Staging nginx is healthy"
                break
              elif [ $i -eq 5 ]; then
                echo "âŒ Staging nginx health check failed"
                docker compose logs nginx
                exit 1
              else
                echo "â³ Waiting for staging nginx... (attempt $i/5)"
                sleep 10
              fi
            done
            
            echo "ğŸ‰ Staging deployment completed successfully!"
            echo "ğŸŒ Staging available at: https://fluently-app.online"
            
            # Show running containers
            docker compose ps
